<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave Video Player - Working Version</title>
    
    <!-- Video.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.5.2/video-js.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0078d4, #005a9e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .main-content {
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .input-field {
            flex: 1;
            min-width: 250px;
        }

        .input-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-field input, .input-field select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0078d4, #005a9e);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 120, 212, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 120, 212, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-preset {
            padding: 6px 12px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-preset:hover {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .video-section {
            margin-bottom: 25px;
        }

        .video-js {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100% !important;
            height: 500px !important;
        }

        .message-area {
            margin-top: 15px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }

        .logs-section {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 3px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #888;
        }

        .log-error {
            color: #ff4444;
        }

        .log-info {
            color: #44aaff;
        }

        .log-success {
            color: #44ff44;
        }

        .log-warning {
            color: #ffaa44;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-field {
                min-width: auto;
            }
            
            .btn-group {
                flex-direction: column;
            }

            .video-js {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dave's Video Player</h1>
            <p>Professional HLS & DASH Streaming Tool</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label for="streamUrl">Stream URL (.m3u8 or .mpd)</label>
                        <input type="url" id="streamUrl" placeholder="https://your-domain.com/stream.m3u8" />
                    </div>
                    <div class="input-field">
                        <label for="streamType">Stream Type</label>
                        <select id="streamType">
                            <option value="auto">Auto Detect</option>
                            <option value="hls">HLS (.m3u8)</option>
                            <option value="dash">DASH (.mpd)</option>
                        </select>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="loadStream()">Load Stream</button>
                    <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn-preset" onclick="loadPreset('hls-demo')">HLS Demo</button>
                    <button class="btn-preset" onclick="loadPreset('apple-demo')">Apple Demo</button>
                    <button class="btn-preset" onclick="loadPreset('sintel')">Sintel Demo</button>
                </div>
                
                <div id="messageArea" class="message-area"></div>
            </div>
            
            <div class="video-section">
                <video
                    id="videoPlayer"
                    class="video-js vjs-default-skin"
                    controls
                    preload="auto"
                    data-setup="{}">
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a web browser that
                        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                    </p>
                </video>
            </div>

            <div class="logs-section" id="generalLogs">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[Ready]</span> Dave's Video Player initialized
                </div>
            </div>
        </div>
    </div>

    <!-- Video.js JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.5.2/video.min.js"></script>
    <!-- HLS.js for HLS support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>

    <script>
        let player;
        let hlsInstance;
        let diagnosticsOpen = false;
        let metricsInterval;
        let currentLevels = [];
        
        // Metrics tracking
        let metrics = {
            qualitySwitches: 0,
            startTime: null,
            bandwidth: [],
            bufferHealth: []
        };
        
        // Wait for DOM and scripts to load
        document.addEventListener('DOMContentLoaded', function() {
            // Add a delay to ensure all scripts are loaded
            setTimeout(() => {
                initializePlayer();
            }, 1000);
        });

        function initializePlayer() {
            try {
                logEvent('info', 'Checking Video.js availability...');
                
                if (typeof videojs === 'undefined') {
                    logEvent('error', 'Video.js library not loaded - check internet connection');
                    showMessage('Video.js library failed to load. Please check your internet connection and refresh the page.', 'error');
                    return;
                }

                logEvent('info', 'Video.js found, initializing player...');

                // Simple VideoJS configuration
                const options = {
                    controls: true,
                    responsive: true,
                    fluid: false,
                    playbackRates: [0.5, 1, 1.5, 2],
                    preload: 'auto'
                };

                player = videojs('videoPlayer', options);
                
                player.ready(() => {
                    logEvent('success', 'Video.js player ready!');
                    setupBasicEvents();
                    startMetricsCollection();
                    showMessage('Player initialized successfully!', 'success');
                });

            } catch (error) {
                logEvent('error', `Failed to initialize player: ${error.message}`);
                showMessage(`Failed to initialize player: ${error.message}`, 'error');
            }
        }

        function setupBasicEvents() {
            if (!player) return;

            player.on('loadstart', () => {
                logEvent('info', 'Stream loading started');
                metrics.startTime = Date.now();
            });
            
            player.on('loadeddata', () => {
                logEvent('success', 'Stream data loaded');
            });
            
            player.on('canplay', () => {
                logEvent('success', 'Stream ready to play');
            });
            
            player.on('playing', () => {
                logEvent('success', 'Playback started');
            });
            
            player.on('pause', () => {
                logEvent('info', 'Playback paused');
            });
            
            player.on('timeupdate', () => {
                updatePlaybackTime();
            });
            
            player.on('error', (e) => {
                const error = player.error();
                const errorMsg = error ? `${error.code}: ${error.message}` : 'Unknown error';
                logEvent('error', `Player error: ${errorMsg}`);
                showMessage(`Playback error: ${errorMsg}`, 'error');
            });
        }

        function loadStream() {
            const url = document.getElementById('streamUrl').value.trim();
            const streamType = document.getElementById('streamType').value;
            
            if (!url) {
                showMessage('Please enter a stream URL', 'error');
                return;
            }

            if (!player) {
                showMessage('Player not ready. Please wait and try again.', 'error');
                return;
            }

            clearMessage();
            logEvent('info', `Loading stream: ${url}`);
            resetMetrics();

            // Clean up existing HLS instance
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                    hlsInstance = null;
                    logEvent('info', 'Previous HLS instance cleaned up');
                } catch (e) {
                    logEvent('info', 'HLS cleanup completed');
                }
            }

            // Hide quality controls until we know what's available
            document.getElementById('qualityControls').style.display = 'none';
            currentLevels = [];

            // Auto-detect stream type
            let detectedType = streamType;
            if (streamType === 'auto') {
                if (url.includes('.m3u8')) {
                    detectedType = 'hls';
                } else if (url.includes('.mpd')) {
                    detectedType = 'dash';
                } else {
                    detectedType = 'hls'; // default assumption
                }
            }

            logEvent('info', `Stream type: ${detectedType.toUpperCase()}`);
            updateElement('streamType', detectedType.toUpperCase());
            updateElement('streamInfo', 'Loading...');

            if (detectedType === 'hls') {
                loadHLSStream(url);
            } else if (detectedType === 'dash') {
                // For DASH, try direct loading first
                loadDirectStream(url, 'application/dash+xml');
            } else {
                // Try direct loading
                loadDirectStream(url);
            }
        }() {
            const url = document.getElementById('streamUrl').value.trim();
            const streamType = document.getElementById('streamType').value;
            
            if (!url) {
                showMessage('Please enter a stream URL', 'error');
                return;
            }

            if (!player) {
                showMessage('Player not ready. Please wait and try again.', 'error');
                return;
            }

            clearMessage();
            logEvent('info', `Loading stream: ${url}`);
            resetMetrics();

            // Clean up existing HLS instance
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                    hlsInstance = null;
                    logEvent('info', 'Previous HLS instance cleaned up');
                } catch (e) {
                    logEvent('info', 'HLS cleanup completed');
                }
            }

            // Hide quality controls until we know what's available
            document.getElementById('qualityControls').style.display = 'none';
            currentLevels = [];

            // Auto-detect stream type
            let detectedType = streamType;
            if (streamType === 'auto') {
                if (url.includes('.m3u8')) {
                    detectedType = 'hls';
                } else if (url.includes('.mpd')) {
                    detectedType = 'dash';
                } else {
                    detectedType = 'hls'; // default assumption
                }
            }

            logEvent('info', `Stream type: ${detectedType.toUpperCase()}`);
            updateElement('streamType', detectedType.toUpperCase());
            updateElement('streamInfo', 'Loading...');

            if (detectedType === 'hls') {
                loadHLSStream(url);
            } else if (detectedType === 'dash') {
                // For DASH, try direct loading first
                loadDirectStream(url, 'application/dash+xml');
            } else {
                // Try direct loading
                loadDirectStream(url);
            }
        }

        function loadHLSStream(url) {
            const videoElement = player.tech().el();
            
            // Check if browser supports HLS natively (Safari)
            if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                logEvent('info', 'Using native HLS support');
                updateElement('streamInfo', 'Native HLS');
                player.src({
                    src: url,
                    type: 'application/vnd.apple.mpegurl'
                });
                showMessage('Stream loaded with native HLS support!', 'success');
                return;
            }
            
            // Use HLS.js for other browsers
            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                try {
                    logEvent('info', 'Using HLS.js for stream playback');
                    updateElement('streamInfo', 'HLS.js');
                    
                    hlsInstance = new Hls({
                        debug: false,
                        enableWorker: true
                    });
                    
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(videoElement);
                    
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                        logEvent('success', `HLS manifest parsed - ${data.levels.length} quality levels found`);
                        currentLevels = data.levels;
                        populateQualityLevels(data.levels);
                        showMessage('HLS stream loaded successfully!', 'success');
                        updateElement('streamInfo', `${data.levels.length} levels`);
                    });
                    
                    hlsInstance.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                        metrics.qualitySwitches++;
                        logEvent('info', `Quality switched to level ${data.level}`);
                        updateQualityDisplay(data.level);
                        updateElement('qualitySwitches', metrics.qualitySwitches);
                    });

                    hlsInstance.on(Hls.Events.FRAG_LOADED, function(event, data) {
                        // Update bandwidth info when fragments load
                        if (hlsInstance.bandwidthEstimate) {
                            const bw = Math.round(hlsInstance.bandwidthEstimate / 1000);
                            updateElement('bandwidth', `${bw} kbps`);
                            
                            // Store bandwidth data for trend analysis
                            metrics.bandwidth.push({
                                time: Date.now(),
                                value: bw
                            });
                            
                            // Keep only last 10 readings
                            if (metrics.bandwidth.length > 10) {
                                metrics.bandwidth.shift();
                            }
                            
                            updateBandwidthTrend();
                        }
                    });
                    
                    hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                        logEvent('error', `HLS Error: ${data.type} - ${data.details}`);
                        
                        if (data.fatal) {
                            showMessage(`Fatal HLS error: ${data.details}`, 'error');
                            
                            // Try basic recovery
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    logEvent('info', 'Attempting network error recovery');
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            hlsInstance.startLoad();
                                        }
                                    }, 1000);
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    logEvent('info', 'Attempting media error recovery');
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            hlsInstance.recoverMediaError();
                                        }
                                    }, 1000);
                                    break;
                                default:
                                    logEvent('error', 'Cannot recover from this error type');
                                    break;
                            }
                        }
                    });

                    logEvent('success', 'HLS.js instance created and attached');
                } catch (error) {
                    logEvent('error', `HLS.js initialization failed: ${error.message}`);
                    showMessage(`HLS.js failed: ${error.message}`, 'error');
                    
                    // Fallback to direct loading
                    loadDirectStream(url, 'application/vnd.apple.mpegurl');
                }
            } else {
                logEvent('warning', 'HLS.js not available, trying direct loading');
                loadDirectStream(url, 'application/vnd.apple.mpegurl');
            }
        }

        function loadDirectStream(url, mimeType = null) {
            try {
                logEvent('info', 'Attempting direct stream loading');
                updateElement('streamInfo', 'Direct');
                
                const sourceObj = { src: url };
                if (mimeType) {
                    sourceObj.type = mimeType;
                }
                
                player.src(sourceObj);
                showMessage('Stream loaded directly!', 'success');
                
            } catch (error) {
                logEvent('error', `Direct loading failed: ${error.message}`);
                showMessage(`Direct loading failed: ${error.message}`, 'error');
            }
        }

        function populateQualityLevels(levels) {
            const container = document.getElementById('qualityLevels');
            const controls = document.getElementById('qualityControls');
            
            if (!container || !controls) return;
            
            // Clear existing buttons
            container.innerHTML = '';
            
            // Add Auto button
            const autoBtn = document.createElement('button');
            autoBtn.className = 'quality-btn active';
            autoBtn.textContent = 'Auto';
            autoBtn.onclick = () => setQualityLevel(-1);
            container.appendChild(autoBtn);
            
            // Add quality level buttons
            levels.forEach((level, index) => {
                const btn = document.createElement('button');
                btn.className = 'quality-btn';
                btn.textContent = `${level.height}p`;
                btn.onclick = () => setQualityLevel(index);
                container.appendChild(btn);
            });
            
            // Show quality controls
            controls.style.display = 'block';
            logEvent('info', `Quality controls populated with ${levels.length} levels`);
        }

        function setQualityLevel(level) {
            if (!hlsInstance) {
                logEvent('warning', 'Cannot change quality - HLS instance not available');
                return;
            }
            
            hlsInstance.currentLevel = level;
            logEvent('info', `Manual quality level set to: ${level === -1 ? 'Auto' : level}`);
            
            // Update button states
            document.querySelectorAll('.quality-btn').forEach(btn => btn.classList.remove('active'));
            const buttons = document.querySelectorAll('.quality-btn');
            if (level === -1 && buttons[0]) {
                buttons[0].classList.add('active');
            } else if (buttons[level + 1]) {
                buttons[level + 1].classList.add('active');
            }
        }

        function updateQualityDisplay(levelIndex) {
            if (currentLevels && currentLevels[levelIndex]) {
                const level = currentLevels[levelIndex];
                updateElement('currentRes', `${level.width}x${level.height}`);
                updateElement('qualityTrend', `${Math.round(level.bitrate/1000)} kbps`);
            }
        }

        function startMetricsCollection() {
            if (metricsInterval) clearInterval(metricsInterval);
            
            metricsInterval = setInterval(() => {
                if (player) {
                    updateBufferMetrics();
                }
            }, 1000);
        }

        function updateBufferMetrics() {
            if (!player || typeof player.buffered !== 'function') return;

            try {
                const buffered = player.buffered();
                const currentTime = player.currentTime();
                let bufferAhead = 0;
                
                for (let i = 0; i < buffered.length; i++) {
                    const start = buffered.start(i);
                    const end = buffered.end(i);
                    
                    if (currentTime >= start && currentTime <= end) {
                        bufferAhead = end - currentTime;
                        break;
                    }
                }

                updateElement('bufferLevel', `${Math.round(bufferAhead)}s`);

                // Update buffer trend
                let bufferStatus = 'Optimal';
                if (bufferAhead < 3) {
                    bufferStatus = 'Low';
                } else if (bufferAhead > 15) {
                    bufferStatus = 'High';
                }
                updateElement('bufferTrend', bufferStatus);
                
                // Store buffer data
                metrics.bufferHealth.push({
                    time: Date.now(),
                    value: bufferAhead
                });
                
                // Keep only last 10 readings
                if (metrics.bufferHealth.length > 10) {
                    metrics.bufferHealth.shift();
                }

            } catch (error) {
                updateElement('bufferLevel', '-');
            }
        }

        function updateBandwidthTrend() {
            if (metrics.bandwidth.length < 2) return;
            
            const current = metrics.bandwidth[metrics.bandwidth.length - 1].value;
            const previous = metrics.bandwidth[metrics.bandwidth.length - 2].value;
            const change = current - previous;
            
            let trend = 'Stable';
            if (Math.abs(change) > current * 0.1) { // 10% change threshold
                trend = change > 0 ? 'Increasing' : 'Decreasing';
            }
            
            updateElement('bandwidthTrend', trend);
        }

        function updatePlaybackTime() {
            if (!player) return;
            
            const currentTime = player.currentTime();
            const duration = player.duration();
            
            if (currentTime && !isNaN(currentTime)) {
                updateElement('playbackTime', formatTime(currentTime));
            }
            
            if (duration && !isNaN(duration)) {
                updateElement('durationInfo', `/ ${formatTime(duration)}`);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function resetMetrics() {
            metrics = {
                qualitySwitches: 0,
                startTime: Date.now(),
                bandwidth: [],
                bufferHealth: []
            };
            
            // Reset UI
            updateElement('qualitySwitches', '0');
            updateElement('bandwidth', '- kbps');
            updateElement('bufferLevel', '- seconds');
            updateElement('currentRes', '-');
            updateElement('playbackTime', '00:00');
            updateElement('durationInfo', '/ 00:00');
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function toggleDiagnostics() {
            diagnosticsOpen = !diagnosticsOpen;
            const content = document.getElementById('diagnosticsContent');
            const arrow = document.getElementById('diagnosticsArrow');
            
            if (content && arrow) {
                if (diagnosticsOpen) {
                    content.classList.add('open');
                    arrow.textContent = '▲';
                } else {
                    content.classList.remove('open');
                    arrow.textContent = '▼';
                }
            }
        }

        function loadPreset(preset) {
            const presets = {
                'hls-demo': {
                    url: 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8',
                    type: 'hls'
                },
                'apple-demo': {
                    url: 'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_ts/master.m3u8',
                    type: 'hls'
                },
                'sintel': {
                    url: 'https://multiplatform-f.akamaihd.net/i/multi/will/bunny/big_buck_bunny_,640x360_400,640x360_700,640x360_1000,950x540_1500,.f4v.csmil/master.m3u8',
                    type: 'hls'
                }
            };

            if (presets[preset]) {
                const urlInput = document.getElementById('streamUrl');
                const typeSelect = document.getElementById('streamType');
                
                if (urlInput) urlInput.value = presets[preset].url;
                if (typeSelect) typeSelect.value = presets[preset].type;
                
                logEvent('info', `Loaded ${preset} preset`);
                showMessage(`Loaded ${preset} preset - click "Load Stream" to play`, 'success');
            }
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            if (messageArea) {
                messageArea.innerHTML = `<div class="${type}-message">${message}</div>`;
                
                // Auto-clear success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        clearMessage();
                    }, 5000);
                }
            }
        }

        function clearMessage() {
            const messageArea = document.getElementById('messageArea');
            if (messageArea) {
                messageArea.innerHTML = '';
            }
        }

        function logEvent(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsSection = document.getElementById('generalLogs');
            
            if (logsSection) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
                
                logsSection.appendChild(logEntry);
                logsSection.scrollTop = logsSection.scrollHeight;
                
                // Keep only last 100 log entries
                const logEntries = logsSection.getElementsByClassName('log-entry');
                if (logEntries.length > 100) {
                    logsSection.removeChild(logEntries[0]);
                }
            }
            
            // Also log to console for debugging
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            const generalLogs = document.getElementById('generalLogs');
            if (generalLogs) {
                generalLogs.innerHTML = 
                    '<div class="log-entry log-info"><span class="log-timestamp">[Cleared]</span> Logs cleared</div>';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (metricsInterval) clearInterval(metricsInterval);
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    // Ignore cleanup errors
                }
            }
            if (player) {
                try {
                    player.dispose();
                } catch (e) {
                    // Ignore disposal errors
                }
            }
        });

        // Additional debugging
        window.addEventListener('error', function(e) {
            logEvent('error', `JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`);
        });
    </script>() {
            const url = document.getElementById('streamUrl').value.trim();
            const streamType = document.getElementById('streamType').value;
            
            if (!url) {
                showMessage('Please enter a stream URL', 'error');
                return;
            }

            if (!player) {
                showMessage('Player not ready. Please wait and try again.', 'error');
                return;
            }

            clearMessage();
            logEvent('info', `Loading stream: ${url}`);

            // Clean up existing HLS instance
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                    hlsInstance = null;
                    logEvent('info', 'Previous HLS instance cleaned up');
                } catch (e) {
                    logEvent('info', 'HLS cleanup completed');
                }
            }

            // Auto-detect stream type
            let detectedType = streamType;
            if (streamType === 'auto') {
                if (url.includes('.m3u8')) {
                    detectedType = 'hls';
                } else if (url.includes('.mpd')) {
                    detectedType = 'dash';
                } else {
                    detectedType = 'hls'; // default assumption
                }
            }

            logEvent('info', `Stream type: ${detectedType.toUpperCase()}`);

            if (detectedType === 'hls') {
                loadHLSStream(url);
            } else if (detectedType === 'dash') {
                // For DASH, try direct loading first
                loadDirectStream(url, 'application/dash+xml');
            } else {
                // Try direct loading
                loadDirectStream(url);
            }
        }

        function loadHLSStream(url) {
            const videoElement = player.tech().el();
            
            // Check if browser supports HLS natively (Safari)
            if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                logEvent('info', 'Using native HLS support');
                player.src({
                    src: url,
                    type: 'application/vnd.apple.mpegurl'
                });
                showMessage('Stream loaded with native HLS support!', 'success');
                return;
            }
            
            // Use HLS.js for other browsers
            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                try {
                    logEvent('info', 'Using HLS.js for stream playback');
                    
                    hlsInstance = new Hls({
                        debug: false,
                        enableWorker: true
                    });
                    
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(videoElement);
                    
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                        logEvent('success', `HLS manifest parsed - ${data.levels.length} quality levels found`);
                        showMessage('HLS stream loaded successfully!', 'success');
                    });
                    
                    hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                        logEvent('error', `HLS Error: ${data.type} - ${data.details}`);
                        
                        if (data.fatal) {
                            showMessage(`Fatal HLS error: ${data.details}`, 'error');
                            
                            // Try basic recovery
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    logEvent('info', 'Attempting network error recovery');
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            hlsInstance.startLoad();
                                        }
                                    }, 1000);
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    logEvent('info', 'Attempting media error recovery');
                                    setTimeout(() => {
                                        if (hlsInstance) {
                                            hlsInstance.recoverMediaError();
                                        }
                                    }, 1000);
                                    break;
                                default:
                                    logEvent('error', 'Cannot recover from this error type');
                                    break;
                            }
                        }
                    });

                    logEvent('success', 'HLS.js instance created and attached');
                } catch (error) {
                    logEvent('error', `HLS.js initialization failed: ${error.message}`);
                    showMessage(`HLS.js failed: ${error.message}`, 'error');
                    
                    // Fallback to direct loading
                    loadDirectStream(url, 'application/vnd.apple.mpegurl');
                }
            } else {
                logEvent('warning', 'HLS.js not available, trying direct loading');
                loadDirectStream(url, 'application/vnd.apple.mpegurl');
            }
        }

        function loadDirectStream(url, mimeType = null) {
            try {
                logEvent('info', 'Attempting direct stream loading');
                
                const sourceObj = { src: url };
                if (mimeType) {
                    sourceObj.type = mimeType;
                }
                
                player.src(sourceObj);
                showMessage('Stream loaded directly!', 'success');
                
            } catch (error) {
                logEvent('error', `Direct loading failed: ${error.message}`);
                showMessage(`Direct loading failed: ${error.message}`, 'error');
            }
        }

        function loadPreset(preset) {
            const presets = {
                'hls-demo': {
                    url: 'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8',
                    type: 'hls'
                },
                'apple-demo': {
                    url: 'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_ts/master.m3u8',
                    type: 'hls'
                },
                'sintel': {
                    url: 'https://multiplatform-f.akamaihd.net/i/multi/will/bunny/big_buck_bunny_,640x360_400,640x360_700,640x360_1000,950x540_1500,.f4v.csmil/master.m3u8',
                    type: 'hls'
                }
            };

            if (presets[preset]) {
                const urlInput = document.getElementById('streamUrl');
                const typeSelect = document.getElementById('streamType');
                
                if (urlInput) urlInput.value = presets[preset].url;
                if (typeSelect) typeSelect.value = presets[preset].type;
                
                logEvent('info', `Loaded ${preset} preset`);
                showMessage(`Loaded ${preset} preset - click "Load Stream" to play`, 'success');
            }
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            if (messageArea) {
                messageArea.innerHTML = `<div class="${type}-message">${message}</div>`;
                
                // Auto-clear success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        clearMessage();
                    }, 5000);
                }
            }
        }

        function clearMessage() {
            const messageArea = document.getElementById('messageArea');
            if (messageArea) {
                messageArea.innerHTML = '';
            }
        }

        function logEvent(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logsSection = document.getElementById('generalLogs');
            
            if (logsSection) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
                
                logsSection.appendChild(logEntry);
                logsSection.scrollTop = logsSection.scrollHeight;
                
                // Keep only last 100 log entries
                const logEntries = logsSection.getElementsByClassName('log-entry');
                if (logEntries.length > 100) {
                    logsSection.removeChild(logEntries[0]);
                }
            }
            
            // Also log to console for debugging
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            const generalLogs = document.getElementById('generalLogs');
            if (generalLogs) {
                generalLogs.innerHTML = 
                    '<div class="log-entry log-info"><span class="log-timestamp">[Cleared]</span> Logs cleared</div>';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (hlsInstance) {
                try {
                    hlsInstance.destroy();
                } catch (e) {
                    // Ignore cleanup errors
                }
            }
            if (player) {
                try {
                    player.dispose();
                } catch (e) {
                    // Ignore disposal errors
                }
            }
        });

        // Additional debugging
        window.addEventListener('error', function(e) {
            logEvent('error', `JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`);
        });
    </script>
</body>
</html>
